<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Jadwal Kelas Sekolah</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Menggunakan font Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .schedule-table th, .schedule-table td {
            padding: 12px;
            text-align: left;
        }
        /* Styling khusus untuk input di editor admin */
        .admin-edit-table input {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #4a5568;
            background-color: #2d3748;
            color: #e2e8f0;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .admin-edit-table input:focus {
            background-color: #1a202c;
            border-color: #4299e1;
            outline: none;
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p class="ml-4 text-gray-700 font-medium">Memuat...</p>
    </div>

    <!-- Konten Utama Aplikasi -->
    <div class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="text-center py-6 border-b border-gray-200 relative">
            <h1 class="text-4xl font-extrabold text-blue-700">Sistem Jadwal Kelas</h1>
            <p class="mt-2 text-lg text-gray-600">Akses jadwal kelas Anda secara real-time.</p>
            <p id="user-id-display" class="mt-1 text-xs text-gray-400"></p>
            
            <!-- Tombol Keluar (Hanya terlihat saat masuk) -->
            <button id="logout-btn" class="absolute top-6 right-0 bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700 transition duration-150 shadow-md hidden">
                Keluar
            </button>
        </header>

        <!-- Feedback Message -->
        <div id="feedback-message" class="opacity-0 p-3 rounded-md mt-4 text-sm w-full transition-opacity duration-300"></div>

        <!-- Bagian Autentikasi/Pemilihan Kelas -->
        <section id="auth-section" class="hidden bg-white shadow-xl rounded-xl p-8 mt-10 max-w-lg mx-auto">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Masuk atau Pilih Kelas</h2>
            
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700">Email (Untuk Admin: admin@sekolah.edu)</label>
                    <input type="email" id="email" name="email" required placeholder="Masukkan email Anda" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm" />
                </div>
                <div class="mb-6">
                    <label for="login-class-select" class="block text-sm font-medium text-gray-700">Pilih Kelas</label>
                    <select id="login-class-select" name="login-class-select" required class="mt-1 block w-full px-4 py-2 border border-gray-300 bg-white rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                        <!-- Opsi kelas akan diisi oleh JS -->
                    </select>
                </div>
                <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                    Masuk
                </button>
            </form>
        </section>

        <!-- Bagian Aplikasi Utama -->
        <section id="main-app" class="hidden mt-10">
            
            <!-- Kontrol User Biasa -->
            <div class="bg-white p-6 rounded-xl shadow-md mb-8 flex flex-col sm:flex-row justify-between items-center">
                <div class="text-lg font-medium text-gray-700 mb-4 sm:mb-0">
                    Anda melihat jadwal untuk kelas: <span id="current-class-display" class="font-bold text-blue-600"></span>
                </div>
                <div class="flex items-center space-x-3 w-full sm:w-auto">
                    <label for="class-select" class="text-sm font-medium text-gray-700 hidden sm:block">Ganti Kelas:</label>
                    <select id="class-select" class="px-3 py-1 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm w-full sm:w-40">
                        <!-- Opsi kelas akan diisi oleh JS -->
                    </select>
                    <button id="admin-toggle-btn" class="hidden bg-yellow-500 text-white p-2 rounded-lg text-sm font-medium hover:bg-yellow-600 transition duration-150">
                        Panel Admin
                    </button>
                </div>
            </div>

            <!-- Tampilan Jadwal -->
            <div id="schedule-display" class="grid grid-cols-1 gap-6">
                <!-- Jadwal akan dirender di sini -->
            </div>
            
            <!-- Panel Admin (Hidden by Default) -->
            <div id="admin-panel" class="hidden bg-gray-800 p-6 rounded-xl shadow-2xl mt-10 text-white">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2 border-gray-700">Panel Admin (Edit Jadwal Sekolah)</h2>
                
                <div class="mb-4">
                    <label for="admin-class-select" class="block text-sm font-medium text-gray-300">Pilih Kelas yang Akan Diubah</label>
                    <select id="admin-class-select" class="mt-1 block w-full px-3 py-2 border border-gray-600 bg-gray-700 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm text-white">
                        <!-- Opsi kelas akan diisi oleh JS -->
                    </select>
                </div>

                <!-- Antarmuka Pengeditan Jadwal Baru -->
                <div id="admin-schedule-editor-ui" class="space-y-6 mt-6">
                    <p class="text-gray-400 text-center">Pilih kelas dari dropdown di atas untuk mulai mengedit jadwal.</p>
                </div>

                <button id="save-schedule-btn" class="mt-8 w-full py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150">
                    Simpan Perubahan Jadwal
                </button>
            </div>

        </section>

    </div>

    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('Debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth;
        let userId = null, userClass = null, isAdmin = false;
        
        const ADMIN_EMAIL = 'admin@sekolah.edu';
        const ADMIN_CLASS = 'AdminSekolah';

        const XII_CLASSES = [
            'XII-A', 'XII-B', 'XII-C', 'XII-D', 'XII-E', 
            'XII-F', 'XII-G', 'XII-H', 'XII-I', 'XII-J', 'XII-K'
        ];

        const authSection = document.getElementById('auth-section');
        const mainAppSection = document.getElementById('main-app');
        const scheduleDisplay = document.getElementById('schedule-display');
        const adminPanel = document.getElementById('admin-panel');
        const classSelect = document.getElementById('class-select');
        const currentClassDisplay = document.getElementById('current-class-display');
        const loadingOverlay = document.getElementById('loading-overlay');
        const feedbackMessage = document.getElementById('feedback-message');
        const userIdDisplay = document.getElementById('user-id-display');
        const loginClassSelect = document.getElementById('login-class-select');
        // Tambahkan referensi tombol logout
        const logoutBtn = document.getElementById('logout-btn'); 

        let unsubscribeSchedule = () => {};

        const initFirebase = async () => {
            if (!Object.keys(firebaseConfig).length) {
                console.error("Firebase config is missing.");
                showFeedback('danger', 'Kesalahan: Konfigurasi Firebase tidak ditemukan.');
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                loginClassSelect.innerHTML = XII_CLASSES.map(cls => 
                    `<option value="${cls}">${cls}</option>`
                ).join('') + `<option value="${ADMIN_CLASS}">AdminSekolah</option>`;

                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                else await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    loadingOverlay.classList.add('hidden');
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `ID Pengguna (Debug): ${userId}`;
                        const storedClass = localStorage.getItem('userClass');
                        const storedEmail = localStorage.getItem('userEmail');
                        
                        if (storedClass && storedEmail) {
                            userClass = storedClass;
                            const email = storedEmail;
                            isAdmin = (email === ADMIN_EMAIL && userClass === ADMIN_CLASS);
                            showMainApp();
                        } else {
                            showAuthSection();
                        }
                    } else {
                        userId = crypto.randomUUID();
                        userIdDisplay.textContent = `ID Pengguna (Anonim): ${userId}`;
                        showAuthSection();
                    }
                });

            } catch (error) {
                console.error("Error during Firebase initialization:", error);
                loadingOverlay.classList.add('hidden');
                showFeedback('danger', `Gagal inisialisasi: ${error.message}`);
            }
        };

        const showFeedback = (type, message) => {
            feedbackMessage.textContent = message;
            feedbackMessage.className = `p-3 rounded-md mt-4 text-sm w-full transition-opacity duration-300 ${
                type === 'success' ? 'bg-green-100 text-green-800' :
                type === 'danger' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'
            }`;
            feedbackMessage.classList.remove('opacity-0');
            setTimeout(() => feedbackMessage.classList.add('opacity-0'), 5000);
        };

        const showAuthSection = () => {
            authSection.classList.remove('hidden');
            mainAppSection.classList.add('hidden');
            // Sembunyikan tombol keluar
            logoutBtn.classList.add('hidden'); 
        };

        const showMainApp = () => {
            authSection.classList.add('hidden');
            mainAppSection.classList.remove('hidden');
            // Tampilkan tombol keluar
            logoutBtn.classList.remove('hidden'); 
            
            if (isAdmin) {
                adminPanel.classList.remove('hidden');
                document.getElementById('admin-toggle-btn').classList.remove('hidden');
                populateAdminClassDropdown();
            } else {
                adminPanel.classList.add('hidden');
                document.getElementById('admin-toggle-btn').classList.add('hidden');
            }
            loadClassNames();
            startScheduleListener(userClass);
        };
        
        // --- Handler Logout ---
        const handleLogout = () => {
            unsubscribeSchedule();
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userClass');
            userClass = null;
            isAdmin = false;
            showFeedback('info', 'Anda telah berhasil keluar. Silakan masuk kembali.');
            showAuthSection();
        };

        logoutBtn.addEventListener('click', handleLogout);
        // --- Akhir Handler Logout ---

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const selectedClass = document.getElementById('login-class-select').value;

            if (!email || !selectedClass) {
                showFeedback('danger', 'Email dan Kelas harus diisi.');
                return;
            }

            localStorage.setItem('userEmail', email);
            localStorage.setItem('userClass', selectedClass);
            userClass = selectedClass;
            isAdmin = (email === ADMIN_EMAIL && userClass === ADMIN_CLASS);
            showMainApp();
            showFeedback('success', `Berhasil masuk sebagai ${userClass}.`);
        });

        const loadClassNames = async () => {
            classSelect.innerHTML = XII_CLASSES.map(cls => 
                `<option value="${cls}" ${cls === userClass ? 'selected' : ''}>${cls}</option>`
            ).join('');
        };

        const defaultSchedule = [
            { day: "Senin", time: "07:30 - 08:30", subject: "Matematika Wajib", teacher: "Bpk. Rahmat" },
            { day: "Senin", time: "08:30 - 09:30", subject: "B. Indonesia", teacher: "Ibu Siti" },
            { day: "Senin", time: "09:45 - 10:45", subject: "Biologi", teacher: "Ibu Dian" },
            { day: "Senin", time: "10:45 - 11:45", subject: "Seni Budaya", teacher: "Bpk. Agung" },
            { day: "Senin", time: "11:45 - 12:45", subject: "Penjasorkes", teacher: "Bpk. Tedi" },
            
            { day: "Selasa", time: "07:30 - 08:30", subject: "Fisika", teacher: "Bpk. Budi" },
            { day: "Selasa", time: "08:30 - 09:30", subject: "Sejarah Indonesia", teacher: "Ibu Rina" },
            { day: "Selasa", time: "09:45 - 10:45", subject: "Matematika Minat", teacher: "Bpk. Rahmat" },
            { day: "Selasa", time: "10:45 - 11:45", subject: "B. Inggris", teacher: "Ibu Ani" },
            { day: "Selasa", time: "11:45 - 12:45", subject: "Kimia", teacher: "Ibu Maya" },

            { day: "Rabu", time: "07:30 - 08:30", subject: "Ekonomi", teacher: "Bpk. Yoga" },
            { day: "Rabu", time: "08:30 - 09:30", subject: "Geografi", teacher: "Ibu Wulan" },
            { day: "Rabu", time: "09:45 - 10:45", subject: "B. Indonesia", teacher: "Ibu Siti" },
            { day: "Rabu", time: "10:45 - 11:45", subject: "Informatika", teacher: "Bpk. Dani" },
            { day: "Rabu", time: "11:45 - 12:45", subject: "Biologi", teacher: "Ibu Dian" },

            { day: "Kamis", time: "07:30 - 08:30", subject: "Matematika Wajib", teacher: "Bpk. Rahmat" },
            { day: "Kamis", time: "08:30 - 09:30", subject: "Fisika", teacher: "Bpk. Budi" },
            { day: "Kamis", time: "09:45 - 10:45", subject: "Sejarah Peminatan", teacher: "Ibu Rina" },
            { day: "Kamis", time: "10:45 - 11:45", subject: "B. Inggris", teacher: "Ibu Ani" },
            { day: "Kamis", time: "11:45 - 12:45", subject: "Seni Budaya", teacher: "Bpk. Agung" },
            
            { day: "Jumat", time: "07:30 - 08:30", subject: "Penjasorkes", teacher: "Bpk. Tedi" },
            { day: "Jumat", time: "08:30 - 09:30", subject: "Informatika", teacher: "Bpk. Dani" },
            { day: "Jumat", time: "09:45 - 10:45", subject: "Pendidikan Agama", teacher: "Ibu Linda" },
            { day: "Jumat", time: "10:45 - 11:45", subject: "Geografi", teacher: "Ibu Wulan" },
            { day: "Jumat", time: "11:45 - 12:45", subject: "Ekonomi", teacher: "Bpk. Yoga" },
        ];

        const startScheduleListener = (className) => {
            unsubscribeSchedule();
            if (!className) return;

            currentClassDisplay.textContent = className;
            loadingOverlay.classList.remove('hidden');

            const scheduleRef = doc(db, `artifacts/${appId}/public/data/schedules/${className}`);
            
            unsubscribeSchedule = onSnapshot(scheduleRef, (docSnap) => {
                loadingOverlay.classList.add('hidden');
                let schedule = docSnap.exists() ? (docSnap.data().schedule || defaultSchedule) : defaultSchedule;
                
                if (docSnap.exists()) {
                    showFeedback('success', `Jadwal Kelas ${className} berhasil diperbarui secara real-time.`);
                } else {
                    showFeedback('info', `Jadwal Kelas ${className} belum tersedia, menampilkan data default.`);
                }
                
                renderSchedule(schedule, className);
                
                // Jika admin, pastikan editor admin diperbarui jika kelas yang sama dilihat
                if (isAdmin && document.getElementById('admin-class-select').value === className) {
                    renderAdminEditor(schedule);
                }
            }, (error) => {
                console.error("Error fetching schedule:", error);
                loadingOverlay.classList.add('hidden');
                showFeedback('danger', 'Gagal memuat jadwal. Cek koneksi Anda.');
            });
        };

        const renderSchedule = (scheduleData, className) => {
            const daysOrder = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu", "Minggu"];
            const grouped = scheduleData.reduce((acc, item) => {
                (acc[item.day] = acc[item.day] || []).push(item);
                return acc;
            }, {});

            let html = `<h2 class="text-2xl font-bold mb-4 text-gray-800">Jadwal Kelas ${className}</h2>`;
            html += `<p class="text-sm text-gray-500 mb-6">Diperbarui: ${new Date().toLocaleTimeString('id-ID')}</p>`;

            daysOrder.forEach(day => {
                const dailySchedule = grouped[day];
                if (dailySchedule && dailySchedule.length > 0) {
                    html += `<div class="mb-8 p-4 bg-white shadow-lg rounded-xl transition duration-300 hover:shadow-xl">
                        <h3 class="text-xl font-semibold mb-3 text-blue-600">${day}</h3>
                        <table class="min-w-full divide-y divide-gray-200 schedule-table">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">Waktu</th>
                                    <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                    <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Guru</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">`;
                    
                    dailySchedule.sort((a, b) => a.time.localeCompare(b.time));
                    dailySchedule.forEach(item => {
                        html += `<tr class="hover:bg-gray-50">
                                    <td class="py-2 px-2 whitespace-nowrap text-sm font-medium text-gray-900">${item.time}</td>
                                    <td class="py-2 px-2 whitespace-nowrap text-sm text-gray-700">${item.subject}</td>
                                    <td class="py-2 px-2 whitespace-nowrap text-sm text-gray-700">${item.teacher}</td>
                                </tr>`;
                    });
                    html += `</tbody></table></div>`;
                }
            });
            scheduleDisplay.innerHTML = html;
        };
        
        const populateAdminClassDropdown = async () => {
             const adminClassSelect = document.getElementById('admin-class-select');
             // Admin harus dapat mengedit semua kelas XII
             const classesToEdit = XII_CLASSES; 
             adminClassSelect.innerHTML = `<option value="">-- Pilih Kelas yang Akan Diubah --</option>` +
                 classesToEdit.map(cls => `<option value="${cls}">${cls}</option>`).join('');
                 
             // Pilih kelas yang sedang dilihat jika itu adalah kelas XII
             if (userClass && classesToEdit.includes(userClass)) {
                 adminClassSelect.value = userClass; 
             }
        };

        // --- Render Admin Editor UI ---
        const renderAdminEditor = (scheduleData) => {
            const editorUI = document.getElementById('admin-schedule-editor-ui');
            const daysOrder = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat"];
            const grouped = scheduleData.reduce((acc, item) => {
                (acc[item.day] = acc[item.day] || []).push(item);
                return acc;
            }, {});

            let html = '';
            
            // Urutkan defaultSchedule berdasarkan waktu untuk mendapatkan urutan slot yang benar
            const sortedDefaultSchedule = [...defaultSchedule].sort((a, b) => a.time.localeCompare(b.time));
            
            // Dapatkan semua slot waktu unik yang ada di defaultSchedule
            const uniqueTimeSlots = [...new Set(sortedDefaultSchedule.map(item => item.time))];

            daysOrder.forEach(day => {
                const dailySchedule = grouped[day] || [];
                
                // Buat peta cepat untuk lookup jadwal yang ada berdasarkan waktu
                const scheduleMap = dailySchedule.reduce((map, item) => {
                    map[item.time] = item;
                    return map;
                }, {});

                html += `<div class="p-4 bg-gray-700 rounded-lg">
                    <h4 class="text-lg font-semibold text-gray-200 mb-3">${day}</h4>
                    <table class="min-w-full admin-edit-table">
                        <thead>
                            <tr>
                                <th class="py-2 px-2 text-left text-xs font-medium text-gray-400 uppercase w-1/4">Waktu</th>
                                <th class="py-2 px-2 text-left text-xs font-medium text-gray-400 uppercase">Mata Pelajaran</th>
                                <th class="py-2 px-2 text-left text-xs font-medium text-gray-400 uppercase">Guru</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                // Iterasi berdasarkan slot waktu unik (memastikan semua slot waktu ada)
                uniqueTimeSlots.forEach(timeSlot => {
                    // Coba temukan item untuk hari dan waktu ini
                    const item = scheduleMap[timeSlot] || { subject: '', teacher: '' };

                    html += `
                        <tr class="border-t border-gray-600" data-day="${day}" data-time="${timeSlot}">
                            <td class="py-2 px-2 text-sm text-gray-300">${timeSlot}</td>
                            <td class="py-2 px-2"><input type="text" value="${item.subject || ''}" data-field="subject" placeholder="Nama Pelajaran"></td>
                            <td class="py-2 px-2"><input type="text" value="${item.teacher || ''}" data-field="teacher" placeholder="Nama Guru"></td>
                        </tr>
                    `;
                });
                html += `</tbody></table></div>`;
            });
            editorUI.innerHTML = html;
        };

        document.getElementById('admin-class-select').addEventListener('change', async (e) => {
            const newClass = e.target.value;
            const editorUI = document.getElementById('admin-schedule-editor-ui');
            
            if (!newClass) {
                editorUI.innerHTML = '<p class="text-gray-400 text-center">Pilih kelas untuk mulai mengedit jadwal.</p>';
                return;
            }
            
            const scheduleRef = doc(db, `artifacts/${appId}/public/data/schedules/${newClass}`);
            loadingOverlay.classList.remove('hidden');
            try {
                const docSnap = await getDoc(scheduleRef);
                loadingOverlay.classList.add('hidden');
                const schedule = docSnap.exists() ? (docSnap.data().schedule || defaultSchedule) : defaultSchedule;
                renderAdminEditor(schedule);
                showFeedback('info', `Jadwal Kelas ${newClass} dimuat di panel editor.`);
            } catch (error) {
                console.error("Error fetching admin schedule:", error);
                loadingOverlay.classList.add('hidden');
                renderAdminEditor(defaultSchedule);
                showFeedback('danger', 'Gagal memuat jadwal admin. Memuat data default.');
            }
        });

        document.getElementById('save-schedule-btn').addEventListener('click', async () => {
            const targetClass = document.getElementById('admin-class-select').value;
            if (!targetClass) {
                showFeedback('danger', 'Mohon pilih kelas yang akan disimpan.');
                return;
            }

            // --- Kumpulkan data dari UI (Perbaikan) ---
            const newScheduleData = [];
            const editorRows = document.querySelectorAll('#admin-schedule-editor-ui tr[data-day]');
            
            editorRows.forEach(row => {
                const day = row.dataset.day;
                const time = row.dataset.time;
                const subjectInput = row.querySelector('input[data-field="subject"]');
                const teacherInput = row.querySelector('input[data-field="teacher"]');

                // Hanya simpan item jika setidaknya Mata Pelajaran atau Guru terisi
                if (day && time && subjectInput && teacherInput) {
                    const subject = subjectInput.value.trim();
                    const teacher = teacherInput.value.trim();
                    
                    if (subject || teacher) { // Hanya simpan jika ada konten
                        newScheduleData.push({
                            day: day,
                            time: time,
                            subject: subject,
                            teacher: teacher
                        });
                    }
                }
            });

            if (newScheduleData.length === 0) {
                showFeedback('info', 'Tidak ada data jadwal yang valid untuk disimpan.');
                // Admin mungkin ingin menghapus jadwal. Kita akan simpan data kosong.
            }

            loadingOverlay.classList.remove('hidden');
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/schedules/${targetClass}`);
                // Simpan data, yang bisa berupa array kosong jika semua dihapus
                await setDoc(docRef, { schedule: newScheduleData }); 
                showFeedback('success', `Jadwal untuk Kelas ${targetClass} berhasil disimpan.`);
            } catch (error) {
                console.error("Error saving schedule:", error);
                showFeedback('danger', `Gagal menyimpan jadwal: ${error.message}`);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });
        
        document.getElementById('class-select').addEventListener('change', (e) => {
            const newClass = e.target.value;
            if (newClass) {
                localStorage.setItem('userClass', newClass); 
                userClass = newClass;
                startScheduleListener(userClass);
            }
        });

        initFirebase();
        
        document.getElementById('admin-toggle-btn').addEventListener('click', () => {
            adminPanel.classList.toggle('hidden');
            if (!adminPanel.classList.contains('hidden')) {
                const adminSelect = document.getElementById('admin-class-select');
                
                // Jika userClass adalah salah satu kelas yang dapat diedit, pilih kelas tersebut
                if(userClass && XII_CLASSES.includes(userClass)) {
                    adminSelect.value = userClass;
                } else {
                    // Jika login sebagai AdminSekolah, pastikan dropdown defaultnya tidak kosong
                    // atau muat kelas pertama
                    adminSelect.value = adminSelect.options[1]?.value || ''; 
                }
                adminSelect.dispatchEvent(new Event('change'));
            }
        });

    </script>
</body>
</html>
